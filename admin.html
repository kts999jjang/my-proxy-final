<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 정보 대시보드</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #3a7cfd;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #333;
            --danger-color: #e53935;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            margin: 0;
            padding: 2rem;
        }
        h1, h2 { color: #fff; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        th { background-color: #2a2a2a; font-weight: 500; }
        tr:hover { background-color: #2c2c2c; }
        form { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; margin-top: 20px; display: flex; flex-wrap: wrap; gap: 1rem; }
        input, select, button { font-family: 'Inter', sans-serif; font-size: 1rem; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: #252525; color: var(--text-primary); }
        button { cursor: pointer; background-color: var(--primary-color); border-color: var(--primary-color); font-weight: 500; transition: background-color 0.2s; }
        button:hover { background-color: #4a8cfd; }
        .stat-card { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; text-align: center; }
        .stat-card h3 { margin-top: 0; color: var(--text-secondary); font-weight: 500; }
        .stat-card p { font-size: 2rem; font-weight: 700; margin-bottom: 0; color: #fff; }
        #stats-container { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 3rem; }
        .delete-btn { background-color: var(--danger-color); border-color: var(--danger-color); }
        .delete-btn:hover { background-color: #f44336; }
    </style>
</head>
<body>
    <h1>주식 정보 대시보드</h1>
    <a href="/admin/logout" style="position: absolute; top: 2rem; right: 2rem; color: var(--text-secondary);">로그아웃</a>

    <h2>데이터 현황</h2>
    <div id="stats-container">
        <div class="stat-card">
            <h3>Pinecone 뉴스 수</h3>
            <p id="pinecone-vectors">불러오는 중...</p>
        </div>
        <div class="stat-card">
            <h3>뉴스 데이터 기간</h3>
            <p id="news-range">불러오는 중...</p>
        </div>
        <div class="stat-card">
            <h3>Redis 주식 수</h3>
            <p id="redis-stocks">불러오는 중...</p>
        </div>
    </div>
    
    <h2>주식 추가 / 업데이트</h2>
    <form id="stock-form">
        <input type="text" id="ticker" placeholder="티커 (예: NVDA)" required>
        <input type="text" id="name" placeholder="회사명" required>
        <select id="style" required>
            <option value="leading">주도주</option>
            <option value="growth">성장주</option>
        </select>
        <input type="text" id="keywords" placeholder="키워드 (쉼표로 구분)">
        <button type="submit">저장</button>
    </form>

    <h2>Redis에 저장된 주식 목록</h2>
    <table id="stocks-table">
        <thead>
            <tr>
                <th>티커</th>
                <th>회사명</th>
                <th>스타일</th>
                <th>키워드</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const stockForm = document.getElementById('stock-form');
        const stocksTableBody = document.querySelector('#stocks-table tbody');

        async function fetchStats() {
            const response = await fetch('/admin/api/stats');
            const stats = await response.json();
            document.getElementById('pinecone-vectors').textContent = `${stats.pineconeVectors} 개`;
            document.getElementById('news-range').textContent = `${stats.newsDateRange.oldest} ~ ${stats.newsDateRange.newest}`;
            document.getElementById('redis-stocks').textContent = `${stats.redisStockCount} 개`;
        }

        async function fetchStocks() {
            const response = await fetch('/admin/api/stocks');
            const stocks = await response.json();
            stocksTableBody.innerHTML = '';
            for (const ticker in stocks) {
                let info = {};
                try {
                    if (stocks[ticker]) {
                        info = JSON.parse(stocks[ticker]);
                    }
                } catch (e) {
                    console.error('Failed to parse stock info for ticker:', ticker, stocks[ticker]);
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ticker}</td>
                    <td>${info.name || ''}</td>
                    <td>${info.style || ''}</td>
                    <td>${(info.keywords || []).join(', ')}</td>
                    <td><button class="delete-btn" onclick="deleteStock('${ticker}')">삭제</button></td>
                `;
                stocksTableBody.appendChild(row);
            }
        }

        stockForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const ticker = document.getElementById('ticker').value.toUpperCase();
            const name = document.getElementById('name').value;
            const style = document.getElementById('style').value;
            const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(Boolean);

            const response = await fetch('/admin/api/stocks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }, // 비밀번호는 더 이상 보내지 않음
                body: JSON.stringify({ ticker, name, style, keywords, password })
            });
            if (response.ok) {
                alert('저장되었습니다.');
                stockForm.reset();
                fetchStocks();
            } else {
                alert('오류: ' + (await response.json()).error);
            }
        });

        async function deleteStock(ticker) {
            const response = await fetch('/admin/api/stocks', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }, // 비밀번호는 더 이상 보내지 않음
                body: JSON.stringify({ ticker })
            });
            if (response.ok) {
                alert(`\`${ticker}\`가 삭제되었습니다.`);
                fetchStocks();
            } else {
                alert('오류: ' + (await response.json()).error);
            }
        }

        fetchStats();
        fetchStocks();
    </script>
</body>
</html>
